# Спецификация бинарного формата SEAL v1.0

## Обзор

SEAL — это бинарный формат, разработанный для хранения зашифрованных персональных данных с доступом к полям, защищённым паролем. Разработан AnmiTaliDev под лицензией CC BY-SA 4.0.

**Репозитории:**
- GitHub: https://github.com/AnmiTaliDev/seal

## Магическое число

Каждый SEAL файл начинается с 8-байтового магического числа:
```
1F 53 45 41 4C 1A 0A 00
```

**Расшифровка:**
- `1F` - Уникальный префикс-маркер
- `53 45 41 4C` - ASCII символы "SEAL"
- `1A` - Контрольный байт (SUB символ)
- `0A` - Символ новой строки
- `00` - Нулевой терминатор

## Структура файла

```
[Магическое число: 8 байт]
[Заголовок: Переменная длина]
[Секции: Переменная длина]
[Подвал: Переменная длина]
```

## Структура заголовка

```
[Версия: 1 байт]           // Версия формата (0x01)
[Флаги: 1 байт]            // Флаги функций
[Количество секций: 2 байта] // Количество секций (little-endian)
[Зарезервировано: 4 байта]   // Зарезервировано для будущего использования
```

### Флаги (8 бит)
- Бит 0: Шифрование включено
- Бит 1: Сжатие включено
- Бит 2: Контрольная сумма присутствует
- Бит 3: Расширенные метаданные
- Биты 4-7: Зарезервировано

## Структура секции

Каждая секция следует этому формату:

```
[Тип секции: 1 байт]       // Идентификатор секции
[Флаги: 1 байт]           // Флаги, специфичные для секции
[Длина данных: 4 байта]   // Длина данных (little-endian)
[Данные: Переменная длина] // Данные секции
[Контрольная сумма: 4 байта] // Контрольная сумма CRC32 (опционально)
```

### Типы секций

| Тип | ID | Описание |
|-----|----|----------|
| `NAME` | 0x01 | Имя |
| `SURNAME` | 0x02 | Фамилия |
| `PASSWORD` | 0x03 | Хэш пароля |
| `BIRTHDAY` | 0x04 | Дата рождения |
| `EMAIL` | 0x05 | Электронная почта |
| `PHONE` | 0x06 | Номер телефона |
| `UUID` | 0x07 | Уникальный идентификатор |
| `METADATA` | 0x08 | Дополнительные метаданные |

### Флаги секций (8 бит)
- Бит 0: Зашифрована
- Бит 1: Сжата
- Бит 2: Обязательное поле
- Бит 3: Кодировка UTF-8
- Биты 4-7: Зарезервировано

## Типы данных

### Строковые данные
- UTF-8 строки с префиксом длины
- Формат: `[Длина: 2 байта][UTF-8 данные: Переменная длина]`

### Данные даты (День рождения)
- 8 байт: Год (2), Месяц (1), День (1), Зарезервировано (4)
- Формат: Little-endian

### Данные UUID
- 16 байт: Стандартный формат UUID
- Формат: Совместимо с RFC 4122

### Данные телефона
- Строка с префиксом длины и кодом страны
- Формат: `[Код страны: 2 байта][Длина номера: 2 байта][Номер: Переменная длина]`

## Шифрование

Зашифрованные секции используют AES-256-CBC с выводом ключа PBKDF2:

```
[Соль: 16 байт]            // Случайная соль для PBKDF2
[IV: 16 байт]              // Вектор инициализации
[Зашифрованные данные: Переменная длина] // Данные, зашифрованные AES-256-CBC
```

**Вывод ключа:**
- Алгоритм: PBKDF2-HMAC-SHA256
- Итерации: 100,000
- Соль: 16 случайных байт
- Выход: 32 байта (256-битный ключ)

## Структура подвала

```
[Смещение индекса: 4 байта] // Смещение до индекса секций (little-endian)
[Размер файла: 4 байта]     // Общий размер файла (little-endian)
[Магическое число подвала: 4 байта] // Проверка подвала (0xDEADBEEF)
```

## Индекс секций

Расположен в конце файла (перед подвалом), обеспечивает быстрый доступ:

```
[Количество секций: 2 байта]
Для каждой секции:
  [Тип: 1 байт]
  [Смещение: 4 байта]
  [Длина: 4 байта]
```

## Пример структуры файла

```
Смещение | Содержимое
---------|------------------
0x00     | Магическое число (8 байт)
0x08     | Заголовок (8 байт)
0x10     | Секция UUID
0x28     | Секция NAME
0x45     | Секция SURNAME
0x62     | Секция PASSWORD
0x88     | Секция EMAIL (зашифрована)
0xB5     | Секция PHONE (зашифрована)
0xE2     | Секция BIRTHDAY (зашифрована)
0xFF     | Индекс секций
0x12A    | Подвал (12 байт)
```

## Соображения безопасности

1. **Хранение паролей**: Пароли хранятся как bcrypt хэши, никогда в открытом виде
2. **Шифрование**: Используется промышленный стандарт AES-256-CBC с правильным выводом ключа
3. **Аутентификация**: Каждая зашифрованная секция включает проверку целостности
4. **Уникальность соли**: Каждый файл использует уникальные соли для вывода ключа

## Примечания по реализации

- Все многобайтовые целые числа хранятся в формате little-endian
- Кодировка строк — UTF-8, если не указано иное
- Контрольные суммы CRC32 используют полином IEEE 802.3
- Расширение файла: `.seal`
- MIME тип: `application/x-seal`